#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

// Font families used in the project
const fontFamilies = [
  {
    name: 'Bodoni Moda',
    url: 'https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@400;500;600;700;800;900&display=swap'
  },
  {
    name: 'Cormorant Garamond', 
    url: 'https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap'
  },
  {
    name: 'Crimson Text',
    url: 'https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&display=swap'
  },
  {
    name: 'Fraunces',
    url: 'https://fonts.googleapis.com/css2?family=Fraunces:wght@300;400;500;600;700;800;900&display=swap'
  },
  {
    name: 'Inter',
    url: 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap'
  },
  {
    name: 'Source Serif 4',
    url: 'https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@300;400;500;600;700&display=swap'
  },
  {
    name: 'Space Grotesk',
    url: 'https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap'
  },
  {
    name: 'Unbounded',
    url: 'https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;500;600;700;800;900&display=swap'
  }
];

const USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36';

async function downloadFont(fontFamily) {
  console.log(`Downloading ${fontFamily.name}...`);
  
  try {
    // Get CSS from Google Fonts
    const { stdout: cssContent } = await execAsync(`curl -s -H "User-Agent: ${USER_AGENT}" "${fontFamily.url}"`);
    
    // Extract font URLs
    const fontUrls = cssContent.match(/https:\/\/fonts\.gstatic\.com[^)]*\.woff2/g) || [];
    
    // Download each font file
    for (const fontUrl of fontUrls) {
      const filename = path.basename(fontUrl);
      await execAsync(`curl -s -o "public/fonts/${filename}" "${fontUrl}"`);
      console.log(`  âœ“ ${filename}`);
    }
    
    // Update CSS to use local paths
    const localCss = cssContent.replace(
      /https:\/\/fonts\.gstatic\.com\/s\/[^\/]*\/v[0-9]*\//g,
      '/fonts/'
    );
    
    return `/* ${fontFamily.name} */\n${localCss}\n`;
    
  } catch (error) {
    console.error(`Error downloading ${fontFamily.name}:`, error.message);
    return '';
  }
}

async function main() {
  console.log('ðŸ”¥ Downloading Google Fonts for self-hosting...\n');
  
  // Ensure directories exist
  if (!fs.existsSync('public/fonts')) {
    fs.mkdirSync('public/fonts', { recursive: true });
  }
  
  if (!fs.existsSync('src/styles')) {
    fs.mkdirSync('src/styles', { recursive: true });
  }
  
  // Generate CSS header
  let cssContent = `/* Self-hosted Google Fonts - Generated by POC-9 */\n`;
  cssContent += `/* Original fonts replaced to eliminate render-blocking requests */\n\n`;
  
  // Download each font family
  for (const fontFamily of fontFamilies) {
    const fontCss = await downloadFont(fontFamily);
    cssContent += fontCss + '\n';
  }
  
  // Write final CSS file
  fs.writeFileSync('src/styles/self-hosted-fonts.css', cssContent);
  
  console.log('\nâœ… All fonts downloaded successfully!');
  console.log('âœ… CSS generated at src/styles/self-hosted-fonts.css');
  console.log('\nNext steps:');
  console.log('1. Update daily-themes.json to use local fonts');
  console.log('2. Add font preloading to MainLayout.astro');
  console.log('3. Remove Google Fonts CDN links');
}

main().catch(console.error);