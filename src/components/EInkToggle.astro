---
---

<div class="e-ink-toggle">
  <button id="e-ink-toggle" aria-label="Toggle e-ink reading mode" aria-pressed="false" title="E-Ink Mode">
    <!-- Book/Reader icon for e-ink mode OFF -->
    <svg class="e-ink-off-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <!-- Filled book icon for e-ink mode ON -->
    <svg class="e-ink-on-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
  </button>
</div>

<style>
  .e-ink-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 5rem;
    z-index: 1000;
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
  }

  button {
    background: var(--color-sidebar-bg);
    border: var(--border-default);
    border-radius: 50%;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-default);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
  }

  /* Only apply hover effects on devices that support hover */
  @media (hover: hover) {
    button:hover {
      border: var(--border-hover);
      box-shadow: var(--shadow-hover);
      transform: scale(1.05);
    }
  }

  .e-ink-off-icon,
  .e-ink-on-icon {
    color: var(--color-text);
    width: 20px;
    height: 20px;
  }

  /* Default: show off icon */
  .e-ink-off-icon {
    display: block;
  }
  .e-ink-on-icon {
    display: none;
  }

  /* When e-ink is active: show on icon */
  :global([data-e-ink="true"]) .e-ink-off-icon {
    display: none;
  }
  :global([data-e-ink="true"]) .e-ink-on-icon {
    display: block;
  }

  @media (max-width: 768px) {
    .e-ink-toggle {
      bottom: 1rem;
      right: 4.5rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    button, button:hover {
      transform: none !important;
    }
  }
</style>

<script>
  function initEInkToggle() {
    function getEInkPreference(): boolean {
      const stored = typeof localStorage !== 'undefined' ? localStorage.getItem('e-ink-mode') : null;
      return stored === 'true';
    }

    // Apply initial e-ink state
    const isEInk = getEInkPreference();
    document.documentElement.setAttribute('data-e-ink', isEInk ? 'true' : 'false');

    // Set initial aria-pressed state
    const initialToggle = document.getElementById('e-ink-toggle');
    if (initialToggle) {
      initialToggle.setAttribute('aria-pressed', isEInk ? 'true' : 'false');
    }

    const handleToggleClick = () => {
      const element = document.documentElement;
      const currentState = element.getAttribute('data-e-ink') === 'true';
      const newState = !currentState;

      element.setAttribute('data-e-ink', newState ? 'true' : 'false');
      localStorage.setItem('e-ink-mode', newState ? 'true' : 'false');

      // Update aria-pressed state
      const toggleButton = document.getElementById('e-ink-toggle');
      if (toggleButton) {
        toggleButton.setAttribute('aria-pressed', newState ? 'true' : 'false');
      }

      // If enabling e-ink mode, also set shader to none
      if (newState) {
        element.setAttribute('data-shader', 'none');
      }
    };

    const eInkToggle = document.getElementById('e-ink-toggle');
    if (eInkToggle && eInkToggle.parentNode) {
      // Remove any existing event listeners by cloning
      const newToggle = eInkToggle.cloneNode(true);
      eInkToggle.parentNode.replaceChild(newToggle, eInkToggle);
      newToggle.addEventListener('click', handleToggleClick);
    }
  }

  // Initialize on page load
  initEInkToggle();

  // Re-initialize after Astro navigation
  document.addEventListener('astro:page-load', initEInkToggle);
</script>
