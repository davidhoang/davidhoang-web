---
import dailyThemes from '../data/daily-themes.json';

const themes = dailyThemes.themes || [];
const currentDate = dailyThemes.currentDate;
const hasThemes = themes.length > 0;
---

{hasThemes && (
  <div class="daily-theme-toggle">
    <button
      id="daily-theme-toggle"
      aria-label="Toggle daily AI theme"
      aria-pressed="false"
      title="Toggle Daily AI Theme"
    >
      <svg class="palette-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"></circle>
        <circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"></circle>
        <circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"></circle>
        <circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"></circle>
        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"></path>
      </svg>
      <span class="toggle-label">Daily</span>
    </button>

    <div id="theme-calendar" class="theme-calendar" role="dialog" aria-label="Theme calendar">
      <div class="calendar-header">
        <span class="calendar-title">Daily Themes</span>
        <button id="close-calendar" class="close-btn" aria-label="Close calendar">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <button id="default-theme-btn" class="default-theme-btn" title="Use default theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
          <path d="M3 3v5h5"></path>
        </svg>
        <span>Default Theme</span>
      </button>
      <div class="calendar-grid">
        {themes.map((theme: any) => (
          <button
            class={`calendar-day ${theme.date === currentDate ? 'current' : ''}`}
            data-date={theme.date}
            data-theme-data={JSON.stringify(theme)}
            title={theme.name}
          >
            <span class="day-number">{new Date(theme.date + 'T12:00:00').getDate()}</span>
            <span class="day-name">{theme.name.split(' ')[0]}</span>
            <div
              class="color-preview"
              style={`background: linear-gradient(135deg, ${theme.colors.light['--color-bg']} 50%, ${theme.colors.dark['--color-bg']} 50%);`}
            ></div>
          </button>
        ))}
      </div>
      <div class="calendar-footer">
        <span class="ai-label">Generated by AI daily</span>
      </div>
    </div>
  </div>
)}

<style>
  .daily-theme-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 5rem;
    z-index: 1000;
  }

  button#daily-theme-toggle {
    background: var(--color-sidebar-bg);
    border: var(--border-default);
    border-radius: 24px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-default);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    height: 48px;
    font-family: var(--font-primary);
    font-size: 0.875rem;
    color: var(--color-text);
  }

  button#daily-theme-toggle[aria-pressed="true"] {
    background: var(--color-link);
    color: var(--color-bg);
    border-color: var(--color-link);
  }

  button#daily-theme-toggle[aria-pressed="true"] .palette-icon {
    color: var(--color-bg);
  }

  @media (hover: hover) {
    button#daily-theme-toggle:hover {
      border: var(--border-hover);
      box-shadow: var(--shadow-hover);
      transform: scale(1.02);
    }
  }

  .palette-icon {
    color: var(--color-text);
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .toggle-label {
    font-weight: 500;
  }

  .theme-calendar {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: var(--color-bg);
    border: var(--border-default);
    border-radius: 12px;
    box-shadow: var(--shadow-hover);
    padding: 1rem;
    min-width: 280px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .theme-calendar.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .default-theme-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    margin-bottom: 0.75rem;
    background: var(--color-sidebar-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text);
    transition: all 0.2s ease;
  }

  .default-theme-btn:hover {
    background: var(--color-bg);
    border-color: var(--color-text);
  }

  .default-theme-btn.active {
    background: var(--color-text);
    color: var(--color-bg);
    border-color: var(--color-text);
  }

  .default-theme-btn svg {
    flex-shrink: 0;
  }

  .calendar-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text);
  }

  .close-btn {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--color-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .close-btn:hover {
    color: var(--color-text);
    background: var(--color-sidebar-bg);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.25rem;
  }

  .calendar-day {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem 0.25rem;
    background: var(--color-sidebar-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 36px;
  }

  .calendar-day:hover {
    border-color: var(--color-border);
    transform: scale(1.05);
  }

  .calendar-day.current {
    border-color: var(--color-link);
    background: var(--color-bg);
  }

  .calendar-day.selected {
    border-color: var(--color-link);
    box-shadow: 0 0 0 2px var(--color-link);
  }

  .day-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1;
  }

  .day-name {
    font-size: 0.5rem;
    color: var(--color-muted);
    margin-top: 0.125rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .color-preview {
    width: 20px;
    height: 10px;
    border-radius: 3px;
    margin-top: 0.25rem;
    border: 1px solid var(--color-border);
  }

  .calendar-footer {
    margin-top: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .ai-label {
    font-size: 0.625rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  @media (max-width: 768px) {
    .daily-theme-toggle {
      bottom: 1rem;
      right: 4.5rem;
    }

    .toggle-label {
      display: none;
    }

    button#daily-theme-toggle {
      padding: 0.75rem;
      border-radius: 50%;
      width: 48px;
    }

    .theme-calendar {
      right: -3rem;
      min-width: 260px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    button#daily-theme-toggle,
    .theme-calendar,
    .calendar-day {
      transition: none !important;
      transform: none !important;
    }
  }
</style>

<script define:vars={{ themes, currentDate }}>
  function initDailyTheme() {
    const toggleBtn = document.getElementById('daily-theme-toggle');
    const calendar = document.getElementById('theme-calendar');
    const closeBtn = document.getElementById('close-calendar');
    const defaultBtn = document.getElementById('default-theme-btn');

    if (!toggleBtn || !calendar) return;

    // Check if daily theme mode is enabled
    const isDailyMode = localStorage.getItem('daily-theme-mode') === 'true';
    const selectedDate = localStorage.getItem('daily-theme-date') || currentDate;

    if (isDailyMode) {
      toggleBtn.setAttribute('aria-pressed', 'true');
      applyDailyTheme(selectedDate);
    } else {
      // Mark default as active when not in daily mode
      if (defaultBtn) defaultBtn.classList.add('active');
    }

    // Toggle calendar visibility
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      calendar.classList.toggle('open');
    });

    // Close button
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        calendar.classList.remove('open');
      });
    }

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (!calendar.contains(e.target) && !toggleBtn.contains(e.target)) {
        calendar.classList.remove('open');
      }
    });

    // Default theme button
    if (defaultBtn) {
      defaultBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        // Remove daily theme
        localStorage.setItem('daily-theme-mode', 'false');
        toggleBtn.setAttribute('aria-pressed', 'false');
        removeDailyTheme();

        // Update UI
        defaultBtn.classList.add('active');
        const dayButtons = calendar.querySelectorAll('.calendar-day');
        dayButtons.forEach(b => b.classList.remove('selected'));

        // Close calendar
        setTimeout(() => calendar.classList.remove('open'), 300);
      });
    }

    // Calendar day selection
    const dayButtons = calendar.querySelectorAll('.calendar-day');
    dayButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const date = btn.getAttribute('data-date');

        // Update selection state
        dayButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        if (defaultBtn) defaultBtn.classList.remove('active');

        // Enable daily mode and apply theme
        localStorage.setItem('daily-theme-mode', 'true');
        localStorage.setItem('daily-theme-date', date);
        toggleBtn.setAttribute('aria-pressed', 'true');

        applyDailyTheme(date);

        // Close calendar after selection
        setTimeout(() => calendar.classList.remove('open'), 300);
      });
    });

    // Mark currently selected day
    if (isDailyMode && selectedDate) {
      const selectedBtn = calendar.querySelector(`[data-date="${selectedDate}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
      }
      if (defaultBtn) defaultBtn.classList.remove('active');
    }
  }

  function applyDailyTheme(date) {
    const themeData = themes.find(t => t.date === date);
    if (!themeData) return;

    const root = document.documentElement;
    const isDark = root.getAttribute('data-theme') === 'dark';
    const colors = isDark ? themeData.colors.dark : themeData.colors.light;

    // Apply color variables
    Object.entries(colors).forEach(([key, value]) => {
      root.style.setProperty(key, value);
    });

    // Apply font
    if (themeData.font) {
      root.style.setProperty('--font-primary', themeData.font.stack);

      // Load font if not already loaded
      const fontLink = document.getElementById('daily-theme-font');
      if (!fontLink) {
        const link = document.createElement('link');
        link.id = 'daily-theme-font';
        link.rel = 'stylesheet';
        link.href = themeData.font.url;
        document.head.appendChild(link);
      } else {
        fontLink.href = themeData.font.url;
      }
    }

    // Apply typography variations
    if (themeData.typography) {
      if (themeData.typography.headingWeight) {
        root.style.setProperty('--heading-weight', themeData.typography.headingWeight);
      }
      if (themeData.typography.bodyLineHeight) {
        root.style.setProperty('--body-line-height', themeData.typography.bodyLineHeight);
      }
      if (themeData.typography.letterSpacing) {
        root.style.setProperty('--letter-spacing', themeData.typography.letterSpacing);
      }
      if (themeData.typography.headingLetterSpacing) {
        root.style.setProperty('--heading-letter-spacing', themeData.typography.headingLetterSpacing);
      }
    }

    // Apply layout variables
    if (themeData.layout) {
      if (themeData.layout.borderRadius) {
        root.style.setProperty('--radius-sm', themeData.layout.borderRadius === '0px' ? '0px' : `calc(${themeData.layout.borderRadius} * 0.5)`);
        root.style.setProperty('--radius-md', themeData.layout.borderRadius);
        root.style.setProperty('--radius-lg', `calc(${themeData.layout.borderRadius} * 1.5)`);
        root.style.setProperty('--radius-xl', `calc(${themeData.layout.borderRadius} * 2)`);
      }
      if (themeData.layout.containerMaxWidth) {
        root.style.setProperty('--container-max-width', themeData.layout.containerMaxWidth);
      }
      if (themeData.layout.sectionSpacing) {
        root.style.setProperty('--section-spacing', themeData.layout.sectionSpacing);
      }
      if (themeData.layout.contentPadding) {
        root.style.setProperty('--content-padding', themeData.layout.contentPadding);
      }
    }

    // Mark as using daily theme
    root.setAttribute('data-daily-theme', date);
  }

  function removeDailyTheme() {
    const root = document.documentElement;

    // Remove all inline style overrides
    const dailyProps = [
      // Colors
      '--color-text', '--color-bg', '--color-link', '--color-link-hover',
      '--color-border', '--color-muted', '--color-sidebar-bg',
      '--color-nav-bg', '--color-nav-text',
      // Font
      '--font-primary',
      // Typography
      '--heading-weight', '--body-line-height', '--letter-spacing', '--heading-letter-spacing',
      // Layout
      '--radius-sm', '--radius-md', '--radius-lg', '--radius-xl',
      '--container-max-width', '--section-spacing', '--content-padding'
    ];

    dailyProps.forEach(prop => {
      root.style.removeProperty(prop);
    });

    // Remove font link
    const fontLink = document.getElementById('daily-theme-font');
    if (fontLink) {
      fontLink.remove();
    }

    // Remove marker
    root.removeAttribute('data-daily-theme');
  }

  // Listen for theme toggle changes to update daily theme colors
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        const isDailyMode = localStorage.getItem('daily-theme-mode') === 'true';
        if (isDailyMode) {
          const selectedDate = localStorage.getItem('daily-theme-date') || currentDate;
          applyDailyTheme(selectedDate);
        }
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });

  // Initialize
  initDailyTheme();

  // Re-initialize after navigation
  document.addEventListener('astro:page-load', initDailyTheme);
</script>
