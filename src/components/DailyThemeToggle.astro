---
import dailyThemes from '../data/daily-themes.json';

const themes = dailyThemes.themes || [];
const currentDate = dailyThemes.currentDate;
const hasThemes = themes.length > 0;
---

{hasThemes && (
  <div class="daily-theme-toggle">
    <button
      id="daily-theme-toggle"
      aria-label="Toggle daily AI theme"
      aria-pressed="false"
      title="Toggle Daily AI Theme"
    >
      <svg class="palette-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="13.5" cy="6.5" r="0.5" fill="currentColor"></circle>
        <circle cx="17.5" cy="10.5" r="0.5" fill="currentColor"></circle>
        <circle cx="8.5" cy="7.5" r="0.5" fill="currentColor"></circle>
        <circle cx="6.5" cy="12.5" r="0.5" fill="currentColor"></circle>
        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"></path>
      </svg>
      <span class="toggle-label">Daily</span>
    </button>

    <div id="theme-calendar" class="theme-calendar" role="dialog" aria-label="Theme calendar">
      <div class="calendar-header">
        <span class="calendar-title">Daily themes</span>
        <button id="close-calendar" class="close-btn" aria-label="Close calendar">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="calendar-grid">
        <button id="default-theme-btn" class="calendar-day default-day" title="Use default theme">
          <span class="day-number">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
            </svg>
          </span>
          <span class="day-name">Default</span>
          <div class="color-preview" style="background: linear-gradient(135deg, #ffffff 50%, #1a1a1a 50%);"></div>
        </button>
        <button id="e-ink-theme-btn" class="calendar-day e-ink-day" title="E-Ink reading mode">
          <span class="day-number">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
          </span>
          <span class="day-name">E-Ink</span>
          <div class="color-preview" style="background: linear-gradient(135deg, #f5f5f0 50%, #121212 50%);"></div>
        </button>
        {themes.map((theme: any) => (
          <button
            class={`calendar-day ${theme.date === currentDate ? 'current' : ''}`}
            data-date={theme.date}
            data-theme-data={JSON.stringify(theme)}
            title={theme.name}
          >
            <span class="day-number">{new Date(theme.date + 'T12:00:00').getDate()}</span>
            <span class="day-name">{theme.name.split(' ')[0]}</span>
            <div
              class="color-preview"
              style={`background: linear-gradient(135deg, ${theme.colors.light['--color-bg']} 50%, ${theme.colors.dark['--color-bg']} 50%);`}
            ></div>
          </button>
        ))}
      </div>

      <div class="calendar-footer">
        <div class="sound-row">
          <span class="sound-label">Ambient sound</span>
          <button id="sound-toggle-inline" class="sound-toggle-btn" aria-label="Toggle ambient sound" aria-pressed="false">
            <span class="sound-status">Off</span>
            <span class="sound-switch"></span>
          </button>
        </div>
        <span class="footer-text">AI-generated daily <span class="separator">|</span> <a href="https://arnaud.ai/" target="_blank" rel="noopener noreferrer" class="credit-link">Inspired by arnaud.ai</a></span>
      </div>
    </div>
  </div>
)}

<style>
  .daily-theme-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 5rem;
    z-index: var(--z-theme-toggle);
  }

  button#daily-theme-toggle {
    background: var(--color-sidebar-bg);
    border: var(--border-default);
    border-radius: 24px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    /* Button hover consistency: only transition visual properties, not dimensions */
    transition:
      color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-default);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    height: 48px;
    font-family: var(--font-primary);
    font-size: 0.875rem;
    color: var(--color-text);
  }

  button#daily-theme-toggle[aria-pressed="true"] {
    background: var(--color-link);
    color: var(--color-bg);
    border-color: var(--color-link);
  }

  button#daily-theme-toggle[aria-pressed="true"] .palette-icon {
    color: var(--color-bg);
  }

  @media (hover: hover) {
    button#daily-theme-toggle:hover {
      border: var(--border-hover);
      box-shadow: var(--shadow-hover);
      transform: scale(1.02);
    }
  }

  .palette-icon {
    color: var(--color-text);
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .toggle-label {
    font-weight: 500;
  }

  .theme-calendar {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: var(--color-bg);
    border: var(--border-default);
    border-radius: 12px;
    box-shadow: var(--shadow-hover);
    padding: 1.25rem;
    width: 420px;
    max-width: calc(100vw - 2rem);
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .theme-calendar.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .default-day .day-number {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .default-day .day-number svg {
    width: 14px;
    height: 14px;
  }

  .default-day.active,
  .e-ink-day.active {
    border-color: var(--color-link);
    box-shadow: 0 0 0 2px var(--color-link);
  }

  .e-ink-day .day-number {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .e-ink-day .day-number svg {
    width: 14px;
    height: 14px;
  }

  .calendar-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text);
  }

  .close-btn {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--color-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .close-btn:hover {
    color: var(--color-text);
    background: var(--color-sidebar-bg);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
  }

  @media (max-width: 480px) {
    .calendar-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 360px) {
    .calendar-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .calendar-day {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.625rem 0.5rem;
    background: var(--color-sidebar-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 0;
  }

  .calendar-day:hover {
    border-color: var(--color-border);
    transform: scale(1.05);
  }

  .calendar-day.current {
    border-color: var(--color-link);
    background: var(--color-bg);
  }

  .calendar-day.selected {
    border-color: var(--color-link);
    box-shadow: 0 0 0 2px var(--color-link);
  }

  .day-number {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1;
  }

  .day-name {
    font-size: 0.5625rem;
    color: var(--color-muted);
    margin-top: 0.125rem;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    white-space: nowrap;
  }

  .color-preview {
    width: 20px;
    height: 10px;
    border-radius: 3px;
    margin-top: 0.25rem;
    border: 1px solid var(--color-border);
  }

  .calendar-footer {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .footer-text {
    font-size: 0.6875rem;
    color: var(--color-muted);
  }

  .separator {
    margin: 0 0.375rem;
    opacity: 0.5;
  }

  .credit-link {
    color: var(--color-link);
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .credit-link:hover {
    text-decoration: underline;
  }

  .sound-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .sound-label {
    font-size: 0.75rem;
    color: var(--color-text);
    font-weight: 500;
  }

  .sound-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
  }

  .sound-status {
    font-size: 0.6875rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .sound-switch {
    width: 36px;
    height: 20px;
    background: var(--color-border);
    border-radius: 10px;
    position: relative;
    transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .sound-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: var(--color-bg);
    border-radius: 50%;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  .sound-toggle-btn[aria-pressed="true"] .sound-switch {
    background: var(--color-link);
  }

  .sound-toggle-btn[aria-pressed="true"] .sound-switch::after {
    transform: translateX(16px);
  }

  .sound-toggle-btn[aria-pressed="true"] .sound-status {
    color: var(--color-link);
  }

  @media (max-width: 768px) {
    .daily-theme-toggle {
      bottom: max(1rem, env(safe-area-inset-bottom, 1rem));
      right: max(5.5rem, calc(52px + 1rem + env(safe-area-inset-right, 0px)));
    }

    .toggle-label {
      display: none;
    }

    button#daily-theme-toggle {
      padding: 0.75rem;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .theme-calendar {
      right: -1rem;
      max-width: 95vw;
    }
  }

  @media (max-width: 480px) {
    .daily-theme-toggle {
      bottom: max(0.75rem, env(safe-area-inset-bottom, 0.75rem));
      right: max(5.75rem, calc(56px + 0.75rem + env(safe-area-inset-right, 0px)));
    }

    button#daily-theme-toggle {
      width: 52px;
      height: 52px;
      padding: 0.875rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2), 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .palette-icon {
      width: 22px;
      height: 22px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    button#daily-theme-toggle,
    .theme-calendar,
    .calendar-day {
      transition: none !important;
      transform: none !important;
    }
  }
</style>

<script define:vars={{ themes, currentDate }}>
  function initDailyTheme() {
    const toggleBtn = document.getElementById('daily-theme-toggle');
    const calendar = document.getElementById('theme-calendar');
    const closeBtn = document.getElementById('close-calendar');
    const defaultBtn = document.getElementById('default-theme-btn');
    const eInkBtn = document.getElementById('e-ink-theme-btn');

    if (!toggleBtn || !calendar) return;

    // Check if e-ink mode is active
    const isEInkMode = localStorage.getItem('e-ink-mode') === 'true';

    // Daily theme is ON by default (only off if explicitly set to 'false' or e-ink is on)
    const isDailyMode = !isEInkMode && localStorage.getItem('daily-theme-mode') !== 'false';
    const selectedDate = localStorage.getItem('daily-theme-date') || currentDate;

    if (isEInkMode) {
      // E-Ink mode is active
      toggleBtn.setAttribute('aria-pressed', 'false');
      if (eInkBtn) eInkBtn.classList.add('active');
      document.documentElement.setAttribute('data-e-ink', 'true');
      document.documentElement.setAttribute('data-shader', 'none');
    } else if (isDailyMode) {
      toggleBtn.setAttribute('aria-pressed', 'true');
      applyDailyTheme(selectedDate);

      // Mark currently selected day in the calendar
      // First try exact match, then fall back to most recent theme
      let selectedBtn = calendar.querySelector(`[data-date="${selectedDate}"]`);
      if (!selectedBtn && themes.length > 0) {
        // Fall back to the most recent theme button
        selectedBtn = calendar.querySelector(`[data-date="${themes[0].date}"]`);
      }
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
      }
    } else {
      // Mark default as active when not in daily mode
      if (defaultBtn) defaultBtn.classList.add('active');
    }

    // Check if already initialized using data attribute
    if (toggleBtn.dataset.initialized === 'true') return;
    toggleBtn.dataset.initialized = 'true';

    // Toggle calendar visibility
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      calendar.classList.toggle('open');
    });

    // Close button
    if (closeBtn) {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        calendar.classList.remove('open');
      });
    }

    // Close when clicking outside
    documentClickHandler = (e) => {
      const cal = document.getElementById('theme-calendar');
      const btn = document.getElementById('daily-theme-toggle');
      if (cal && btn && !cal.contains(e.target) && !btn.contains(e.target)) {
        cal.classList.remove('open');
      }
    };
    document.addEventListener('click', documentClickHandler);

    // Default theme button
    if (defaultBtn) {
      defaultBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        // Remove daily theme and e-ink mode
        localStorage.setItem('daily-theme-mode', 'false');
        localStorage.setItem('e-ink-mode', 'false');
        document.documentElement.setAttribute('data-e-ink', 'false');
        const btn = document.getElementById('daily-theme-toggle');
        if (btn) btn.setAttribute('aria-pressed', 'false');
        removeDailyTheme();

        // Update UI - clear all selections and mark default as active
        const cal = document.getElementById('theme-calendar');
        if (cal) {
          cal.querySelectorAll('.calendar-day').forEach(b => {
            b.classList.remove('selected');
            b.classList.remove('active');
          });
        }
        defaultBtn.classList.add('active');
      });
    }

    // E-Ink theme button
    if (eInkBtn) {
      eInkBtn.addEventListener('click', (e) => {
        e.stopPropagation();

        // Enable e-ink mode, disable daily theme
        localStorage.setItem('e-ink-mode', 'true');
        localStorage.setItem('daily-theme-mode', 'false');
        document.documentElement.setAttribute('data-e-ink', 'true');
        document.documentElement.setAttribute('data-shader', 'none');
        const btn = document.getElementById('daily-theme-toggle');
        if (btn) btn.setAttribute('aria-pressed', 'false');
        removeDailyTheme();

        // Update UI - clear all selections and mark e-ink as active
        const cal = document.getElementById('theme-calendar');
        if (cal) {
          cal.querySelectorAll('.calendar-day').forEach(b => {
            b.classList.remove('selected');
            b.classList.remove('active');
          });
        }
        eInkBtn.classList.add('active');
      });
    }

    // Calendar day selection (excluding default and e-ink buttons)
    const dayButtons = calendar.querySelectorAll('.calendar-day:not(.default-day):not(.e-ink-day)');
    dayButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const date = btn.getAttribute('data-date');

        // Update selection state
        const cal = document.getElementById('theme-calendar');
        if (cal) {
          cal.querySelectorAll('.calendar-day').forEach(b => b.classList.remove('selected'));
          cal.querySelectorAll('.calendar-day').forEach(b => b.classList.remove('active'));
        }
        btn.classList.add('selected');

        // Enable daily mode, disable e-ink mode, and apply theme
        localStorage.setItem('daily-theme-mode', 'true');
        localStorage.setItem('daily-theme-date', date);
        localStorage.setItem('e-ink-mode', 'false');
        document.documentElement.setAttribute('data-e-ink', 'false');
        const toggleBtn = document.getElementById('daily-theme-toggle');
        if (toggleBtn) toggleBtn.setAttribute('aria-pressed', 'true');

        applyDailyTheme(date);

        // Dispatch event for preference tracking
        const themeDataStr = btn.getAttribute('data-theme-data');
        if (themeDataStr) {
          try {
            const themeData = JSON.parse(themeDataStr);
            window.dispatchEvent(new CustomEvent('theme-selected', { detail: themeData }));
          } catch (e) {
            // Ignore parse errors
          }
        }
      });
    });
  }

  function applyDailyTheme(date) {
    // Try to find theme for the specific date
    let themeData = themes.find(t => t.date === date);

    // If no theme for this date, fall back to the most recent theme
    if (!themeData && themes.length > 0) {
      // Themes are sorted by date descending, so first one is most recent
      themeData = themes[0];
    }

    if (!themeData) return;

    const root = document.documentElement;
    const isDark = root.getAttribute('data-theme') === 'dark';
    const colors = isDark ? themeData.colors.dark : themeData.colors.light;

    // Apply color variables
    Object.entries(colors).forEach(([key, value]) => {
      root.style.setProperty(key, value);
    });

    // Apply contrast mode
    if (themeData.colors.contrastMode && themeData.colors.contrastMode !== 'standard') {
      root.setAttribute('data-contrast-mode', themeData.colors.contrastMode);
    } else {
      root.removeAttribute('data-contrast-mode');
    }

    // Apply font pairings
    if (themeData.fonts) {
      const headingFont = themeData.fonts.heading;
      const bodyFont = themeData.fonts.body;

      if (headingFont) {
        root.style.setProperty('--font-heading', headingFont.stack);
      }
      if (bodyFont) {
        root.style.setProperty('--font-body', bodyFont.stack);
        root.style.setProperty('--font-primary', bodyFont.stack);
      }

      loadFonts([headingFont, bodyFont].filter(Boolean));
    }

    // Apply typography variations
    if (themeData.typography) {
      if (themeData.typography.headingWeight) {
        root.style.setProperty('--heading-weight', themeData.typography.headingWeight);
      }
      if (themeData.typography.bodyWeight) {
        root.style.setProperty('--body-weight', themeData.typography.bodyWeight);
      }
      if (themeData.typography.bodyLineHeight) {
        root.style.setProperty('--body-line-height', themeData.typography.bodyLineHeight);
      }
      if (themeData.typography.letterSpacing) {
        root.style.setProperty('--letter-spacing', themeData.typography.letterSpacing);
      }
      if (themeData.typography.headingLetterSpacing) {
        root.style.setProperty('--heading-letter-spacing', themeData.typography.headingLetterSpacing);
      }
      if (themeData.typography.headingTransform) {
        root.style.setProperty('--heading-transform', themeData.typography.headingTransform);
      }
      if (themeData.typography.scaleRatio) {
        root.style.setProperty('--scale-ratio', themeData.typography.scaleRatio);
      }
      if (themeData.typography.fontVariationSettings && themeData.typography.fontVariationSettings !== 'normal') {
        root.style.setProperty('--font-variation-settings', themeData.typography.fontVariationSettings);
      }
    }

    // Apply navigation styles
    if (themeData.navigation) {
      root.setAttribute('data-nav-style', themeData.navigation.style || 'floating');
      if (themeData.navigation.height) {
        root.style.setProperty('--nav-height', themeData.navigation.height);
      }
      if (themeData.navigation.padding) {
        root.style.setProperty('--nav-padding', themeData.navigation.padding);
      }
    }

    // Apply card styles
    if (themeData.cards) {
      root.setAttribute('data-card-style', themeData.cards.style || 'elevated');
      if (themeData.cards.shadow && themeData.cards.shadow !== 'none') {
        root.style.setProperty('--card-shadow', themeData.cards.shadow);
      } else {
        root.style.setProperty('--card-shadow', 'none');
      }
      if (themeData.cards.borderWidth) {
        root.style.setProperty('--card-border-width', themeData.cards.borderWidth);
      }
      if (themeData.cards.padding) {
        root.style.setProperty('--card-padding', themeData.cards.padding);
      }
    }

    // Apply layout variables
    if (themeData.layout) {
      if (themeData.layout.borderRadius) {
        root.style.setProperty('--radius-sm', themeData.layout.borderRadius === '0px' ? '0px' : `calc(${themeData.layout.borderRadius} * 0.5)`);
        root.style.setProperty('--radius-md', themeData.layout.borderRadius);
        root.style.setProperty('--radius-lg', `calc(${themeData.layout.borderRadius} * 1.5)`);
        root.style.setProperty('--radius-xl', `calc(${themeData.layout.borderRadius} * 2)`);
      }
      if (themeData.layout.containerMaxWidth) {
        root.style.setProperty('--container-max-width', themeData.layout.containerMaxWidth);
      }
      if (themeData.layout.sectionSpacing) {
        root.style.setProperty('--section-spacing', themeData.layout.sectionSpacing);
      }
      if (themeData.layout.contentPadding) {
        root.style.setProperty('--content-padding', themeData.layout.contentPadding);
      }
      if (themeData.layout.gridStyle && themeData.layout.gridStyle !== 'standard') {
        root.setAttribute('data-grid-style', themeData.layout.gridStyle);
      } else {
        root.removeAttribute('data-grid-style');
      }
    }

    // Apply hero layout
    if (themeData.hero) {
      root.setAttribute('data-hero-layout', themeData.hero.layout || 'centered');
    }

    // Apply link styles
    if (themeData.links) {
      root.setAttribute('data-link-style', themeData.links.style || 'underline');
    }

    // Apply background texture
    if (themeData.background) {
      root.setAttribute('data-bg-texture', themeData.background.texture || 'none');
    }

    // Apply image treatments
    if (themeData.images) {
      root.setAttribute('data-image-style', themeData.images.style || 'vivid');
      root.setAttribute('data-image-hover', themeData.images.hover || 'zoom');
      if (themeData.images.opacity) {
        root.style.setProperty('--image-opacity', themeData.images.opacity);
      }
      if (themeData.images.borderRadius) {
        root.style.setProperty('--image-border-radius', themeData.images.borderRadius);
      }
    }

    // Apply footer styles
    if (themeData.footer) {
      root.setAttribute('data-footer-style', themeData.footer.style || 'classic');
    }

    // Apply shader background
    if (themeData.shader) {
      root.setAttribute('data-shader', themeData.shader.type || 'none');
      if (themeData.shader.colors) {
        root.setAttribute('data-shader-colors', JSON.stringify(themeData.shader.colors));
      }
    } else {
      root.setAttribute('data-shader', 'none');
    }

    // Mark as using daily theme
    root.setAttribute('data-daily-theme', date);
  }

  function loadFonts(fonts) {
    // Remove old font links
    document.querySelectorAll('link[id^="daily-theme-font"]').forEach(el => el.remove());

    // Add new font links
    fonts.forEach((font, index) => {
      if (!font || !font.url) return;
      const link = document.createElement('link');
      link.id = `daily-theme-font-${index}`;
      link.rel = 'stylesheet';
      link.href = font.url;
      document.head.appendChild(link);
    });
  }

  function removeDailyTheme() {
    const root = document.documentElement;

    // Remove all inline style overrides
    const dailyProps = [
      // Colors
      '--color-text', '--color-bg', '--color-link', '--color-link-hover',
      '--color-border', '--color-muted', '--color-sidebar-bg',
      '--color-nav-bg', '--color-nav-text', '--color-card-bg',
      // Fonts
      '--font-primary', '--font-heading', '--font-body',
      // Typography
      '--heading-weight', '--body-weight', '--body-line-height',
      '--letter-spacing', '--heading-letter-spacing', '--heading-transform',
      '--scale-ratio', '--font-variation-settings',
      // Navigation
      '--nav-height', '--nav-padding',
      // Cards
      '--card-shadow', '--card-border-width', '--card-padding',
      // Layout
      '--radius-sm', '--radius-md', '--radius-lg', '--radius-xl',
      '--container-max-width', '--section-spacing', '--content-padding',
      // Images
      '--image-opacity', '--image-border-radius'
    ];

    dailyProps.forEach(prop => {
      root.style.removeProperty(prop);
    });

    // Remove font links
    document.querySelectorAll('link[id^="daily-theme-font"]').forEach(el => el.remove());

    // Remove data attributes
    root.removeAttribute('data-daily-theme');
    root.removeAttribute('data-nav-style');
    root.removeAttribute('data-card-style');
    root.removeAttribute('data-hero-layout');
    root.removeAttribute('data-link-style');
    root.removeAttribute('data-bg-texture');
    root.removeAttribute('data-image-style');
    root.removeAttribute('data-image-hover');
    root.removeAttribute('data-footer-style');
    root.removeAttribute('data-shader');
    root.removeAttribute('data-shader-colors');
    root.removeAttribute('data-grid-style');
    root.removeAttribute('data-contrast-mode');
  }

  // Listen for theme toggle changes to update daily theme colors
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        const isDailyMode = localStorage.getItem('daily-theme-mode') === 'true';
        if (isDailyMode) {
          const selectedDate = localStorage.getItem('daily-theme-date') || currentDate;
          applyDailyTheme(selectedDate);
        }
      }
    });
  });

  observer.observe(document.documentElement, { attributes: true });

  // Initialize
  initDailyTheme();

  // Re-initialize after navigation
  document.addEventListener('astro:page-load', () => {
    initDailyTheme();
  });
</script>

<script>
  import { ambientSound, AmbientSound } from '../scripts/ambient-sound.js';

  function initSoundToggle() {
    const toggleBtn = document.getElementById('sound-toggle-inline');
    if (!toggleBtn) return;

    // Check if already initialized
    if (toggleBtn.dataset.initialized === 'true') return;
    toggleBtn.dataset.initialized = 'true';

    const statusText = toggleBtn.querySelector('.sound-status');

    // Always start with sound OFF on page load/refresh
    // (Browser autoplay restrictions prevent auto-starting audio anyway)
    toggleBtn.setAttribute('aria-pressed', 'false');
    if (statusText) statusText.textContent = 'Off';
    localStorage.setItem('ambient-sound-enabled', 'false');

    // Get current theme mood
    const getCurrentMood = () => {
      const root = document.documentElement;
      const themeDate = root.getAttribute('data-daily-theme');

      if (!themeDate) return 'calm';

      try {
        const themeDataEl = document.querySelector(`[data-date="${themeDate}"]`);
        if (themeDataEl) {
          const themeData = JSON.parse(themeDataEl.getAttribute('data-theme-data') || '{}');
          return AmbientSound.getThemeMood(themeData);
        }
      } catch (e) {
        // Fall back to calm
      }

      return 'calm';
    };

    // Toggle handler
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isPlaying = toggleBtn.getAttribute('aria-pressed') === 'true';

      if (isPlaying) {
        ambientSound.stop();
        toggleBtn.setAttribute('aria-pressed', 'false');
        if (statusText) statusText.textContent = 'Off';
        localStorage.setItem('ambient-sound-enabled', 'false');
      } else {
        const mood = getCurrentMood();
        ambientSound.play(mood);
        toggleBtn.setAttribute('aria-pressed', 'true');
        if (statusText) statusText.textContent = 'On';
        localStorage.setItem('ambient-sound-enabled', 'true');
      }
    });

    // Listen for theme changes to update mood
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-daily-theme') {
          const isPlaying = toggleBtn.getAttribute('aria-pressed') === 'true';
          if (isPlaying) {
            const mood = getCurrentMood();
            ambientSound.changeMood(mood);
          }
        }
      });
    });

    observer.observe(document.documentElement, { attributes: true });
  }

  // Initialize
  initSoundToggle();
  document.addEventListener('astro:page-load', initSoundToggle);
</script>

<script>
  import { trackThemeSelection } from '../scripts/preference-tracker';

  function initPreferenceTracking() {
    // Check if already initialized
    if ((window as any).__preferenceTrackingInitialized) return;
    (window as any).__preferenceTrackingInitialized = true;

    // Listen for theme selection events
    window.addEventListener('theme-selected', ((e: CustomEvent) => {
      if (e.detail) {
        trackThemeSelection(e.detail);
      }
    }) as EventListener);
  }

  // Initialize
  initPreferenceTracking();
  document.addEventListener('astro:page-load', initPreferenceTracking);
</script>
