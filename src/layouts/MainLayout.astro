---
import '../styles/reset.css';
import '../styles/global.css';
import '../styles/self-hosted-fonts.css';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import DailyThemeToggle from '../components/DailyThemeToggle.astro';
import MusicPlayer from '../components/MusicPlayer.astro';
import ShaderBackground from '../components/ShaderBackground';
import FontPreloader from '../components/FontPreloader.astro';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  hideFooter?: boolean;
  pageType?: 'home' | 'blog' | 'about';
}

const { 
  title, 
  description = "The official website of David Hoang", 
  ogImage = "/images/img-dh-web-light.webp",
  hideFooter = false,
  pageType
} = Astro.props;

// Auto-detect page type from URL if not provided
const detectedPageType = pageType || (() => {
  const pathname = Astro.url.pathname;
  if (pathname === '/' || pathname === '') return 'home';
  if (pathname.includes('/writing/') || pathname.includes('/notes/')) return 'blog';
  if (pathname.includes('/about')) return 'about';
  return 'home';
})();

// Get the canonical URL with fallback
const canonicalURL = Astro.site 
  ? new URL(Astro.url.pathname, Astro.site)
  : Astro.url.pathname;

// Construct full URL for ogImage
const siteUrl = (Astro.site ? Astro.site.toString() : 'https://www.davidhoang.com').replace(/\/$/, '');
const ogImageUrl = ogImage.startsWith('http') 
  ? ogImage 
  : `${siteUrl}${ogImage.startsWith('/') ? ogImage : `/${ogImage}`}`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for davidhoang.com" href="/rss.xml" />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={title} />
    <meta property="og:site_name" content="davidhoang.com" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@davidhoang" />
    <meta name="twitter:creator" content="@davidhoang" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={title} />

    <meta name="generator" content={Astro.generator} />

    <!-- Intelligent Font Preloading System -->
    <FontPreloader pageType={detectedPageType} priority={detectedPageType === 'home'} />
    
    <!-- Resource hints for font loading optimization -->
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- DNS prefetch for external resources -->

    <!-- Browser theme color - blends browser UI with site -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#111111" media="(prefers-color-scheme: dark)" />

    <!-- System stack font; remove external font preloads to reduce blocking. If reintroducing, prefer self-hosted and display=swap. -->
    <ViewTransitions fallback="swap" />

    <!-- Inline critical CSS -->
    <style is:inline>
      /* Critical CSS that prevents layout shift */
      :root {
        --color-text: #333;
        --color-bg: #fff;
        --nav-height: 40px;
        --font-primary: 'ABC Diatype', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Inter, system-ui, Arial, sans-serif;
      }
      [data-theme="dark"] {
        --color-text: #e1e1e1;
        --color-bg: #111;
      }
      /* E-Ink mode - must be in critical CSS to prevent flash */
      [data-e-ink="true"] {
        --color-text: #000000;
        --color-bg: #f5f5f0;
      }
      [data-e-ink="true"][data-theme="dark"] {
        --color-text: #e0e0e0;
        --color-bg: #121212;
      }
      
      /* Font loading optimization states */
      html {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Inter, system-ui, Arial, sans-serif;
        font-synthesis: none;
        text-rendering: optimizeLegibility;
      }
      
      /* Apply custom fonts only when critical fonts are loaded */
      html.critical-fonts-loaded {
        font-family: var(--font-primary);
      }
      
      /* Prevent layout shift during font loading */
      html.font-loading h1,
      html.font-loading h2,
      html.font-loading h3 {
        font-weight: 600; /* Match ABC Diatype weight more closely */
        letter-spacing: -0.02em; /* Closer to custom font metrics */
      }
      
      /* Smooth font loading transition */
      html.fonts-loaded * {
        transition: font-family 0.1s ease-out;
      }
      
      body {
        margin: 0;
        padding: 0;
        font-family: inherit;
        color: var(--color-text);
        background-color: var(--color-bg);
      }
      [data-e-ink="true"] body {
        background-color: #f5f5f0;
      }
      [data-e-ink="true"][data-theme="dark"] body {
        background-color: #121212;
      }
      nav {
        height: var(--nav-height);
      }
      [data-e-ink="true"] nav {
        background: #e8e8e3 !important;
      }
      [data-e-ink="true"][data-theme="dark"] nav {
        background: #1a1a1a !important;
      }
      /* Skip to main content link for keyboard users */
      .skip-link {
        position: absolute;
        top: -9999px;
        left: -9999px;
        background: var(--color-text);
        color: var(--color-bg);
        padding: 8px;
        text-decoration: none;
        border-radius: 4px;
        z-index: 10000;
      }
      .skip-link:focus-visible {
        top: 6px;
        left: 6px;
      }
    </style>
    
    <!-- Apply theme and e-ink mode before paint to avoid flash -->
    <script>
      (function(){
        try {
          var stored = localStorage.getItem('theme');
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var theme = stored || (prefersDark ? 'dark' : 'light');
          document.documentElement.setAttribute('data-theme', theme);

          // Apply e-ink mode if enabled
          var eInkMode = localStorage.getItem('e-ink-mode');
          if (eInkMode === 'true') {
            document.documentElement.setAttribute('data-e-ink', 'true');
          }

          // Update browser theme-color to match current theme
          var themeColor = theme === 'dark' ? '#111111' : '#ffffff';
          var metaThemeColor = document.querySelector('meta[name="theme-color"]');
          if (metaThemeColor) {
            metaThemeColor.setAttribute('content', themeColor);
          }
          
          // Initialize font loading optimization early for better LCP
          document.documentElement.classList.add('font-loading');
        } catch(e) {
          // no-op
        }
      })();
    </script>
    
    <!-- Font Loading Optimization Script -->
    <script>
      // Critical font loading optimization for LCP improvement
      (function() {
        'use strict';
        
        // Font loading state management
        var fontState = {
          critical: false,
          theme: false,
          all: false
        };
        
        // Critical fonts for immediate loading
        var criticalFonts = [
          '/fonts/ABCDiatypeVariable.woff2',
          '/fonts/UcC73FwrK3iLTeHuS_nVMrMxCp50SjIa1ZL7.woff2'
        ];
        
        function updateFontLoadingState() {
          var allCriticalLoaded = criticalFonts.every(function(font) {
            return document.querySelector('link[href="' + font + '"]');
          });
          
          if (allCriticalLoaded && !fontState.critical) {
            fontState.critical = true;
            document.documentElement.classList.add('critical-fonts-loaded');
            document.documentElement.classList.remove('font-loading');
          }
        }
        
        // Monitor font loading with Font Loading API
        if ('fonts' in document) {
          document.fonts.ready.then(function() {
            fontState.all = true;
            document.documentElement.classList.add('fonts-loaded');
            
            // Performance mark for LCP measurement
            if ('performance' in window && 'mark' in window.performance) {
              try {
                performance.mark('fonts-loaded');
              } catch(e) {}
            }
          });
          
          // Check specific critical fonts
          criticalFonts.forEach(function(fontUrl) {
            var fontName = fontUrl.includes('ABCDiatype') ? 'ABC Diatype' : 'Inter';
            document.fonts.load('400 16px ' + fontName).then(function() {
              updateFontLoadingState();
            }).catch(function() {
              // Fallback - mark as loaded after timeout
              setTimeout(updateFontLoadingState, 2000);
            });
          });
        } else {
          // Fallback for browsers without Font Loading API
          setTimeout(function() {
            fontState.critical = true;
            fontState.all = true;
            document.documentElement.classList.add('critical-fonts-loaded', 'fonts-loaded');
            document.documentElement.classList.remove('font-loading');
          }, 2000);
        }
        
        // Theme-specific font preloading
        function preloadThemeFonts() {
          var dailyTheme = document.documentElement.getAttribute('data-daily-theme');
          var themeMode = localStorage.getItem('daily-theme-mode');
          
          if (themeMode === 'daily' && dailyTheme && dailyTheme !== 'default') {
            // Preload theme-specific fonts lazily
            var themeLink = document.createElement('link');
            themeLink.rel = 'preload';
            themeLink.href = '/fonts/co3bmX5slCNuHLi8bLeY9MK7whWMhyjYqXtK.woff2'; // Cormorant Garamond
            themeLink.as = 'font';
            themeLink.type = 'font/woff2';
            themeLink.crossOrigin = 'anonymous';
            
            // Add with low priority to not block critical fonts
            requestIdleCallback(function() {
              document.head.appendChild(themeLink);
            }, { timeout: 1000 });
          }
        }
        
        // Initial theme font check
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', preloadThemeFonts);
        } else {
          preloadThemeFonts();
        }
        
        // Monitor theme changes for font optimization
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && 
                mutation.attributeName === 'data-daily-theme') {
              preloadThemeFonts();
            }
          });
        });
        
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-daily-theme']
        });
        
      })();
    </script>

  </head>
  <body>
    <!-- Add inline SVG filter for noise texture -->
    <svg style="position: absolute; width: 0; height: 0;" aria-hidden="true">
      <filter id="noise">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.80"
          numOctaves="4"
          stitchTiles="stitch"
          result="noise"/>
        <feColorMatrix type="saturate" values="0"/>
        <feBlend in="SourceGraphic" in2="noise" mode="multiply"/>
      </filter>
    </svg>

    <!-- Filter wrapper for mood/intensity effects - fixed UI elements must be outside -->
    <div class="content-filter-wrapper">
      <ShaderBackground client:idle />
      <a href="#main-content" class="skip-link">Skip to main content</a>
      <Navigation />
      <main id="main-content" class="container" role="main" aria-label="Main content" tabindex="-1">
        <slot />
      </main>
      {!hideFooter && <Footer />}
    </div>
    <!-- Fixed UI elements outside filter wrapper to maintain position: fixed -->
    <DailyThemeToggle />
    <ThemeToggle />

    <MusicPlayer />
    <script>
      // Helper to update browser theme-color
      function updateBrowserThemeColor(theme) {
        const themeColor = theme === 'dark' ? '#111111' : '#ffffff';
        let metaThemeColor = document.querySelector('meta[name="theme-color"]:not([media])');
        if (!metaThemeColor) {
          metaThemeColor = document.querySelector('meta[name="theme-color"]');
        }
        if (metaThemeColor) {
          metaThemeColor.setAttribute('content', themeColor);
        }
      }

      // Persist theme and e-ink mode during view transitions
      document.addEventListener('astro:after-swap', () => {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);

        // Persist e-ink mode
        const eInkMode = localStorage.getItem('e-ink-mode');
        if (eInkMode === 'true') {
          document.documentElement.setAttribute('data-e-ink', 'true');
        }

        // Update browser theme-color
        updateBrowserThemeColor(theme);

        // Re-init lazy loading after page swap
        initLazyImages();
      });

      // Listen for theme changes (from ThemeToggle component)
      document.addEventListener('theme-changed', (e) => {
        updateBrowserThemeColor(e.detail.theme);
      });

      // Lazy loading with fade-in effect
      function initLazyImages() {
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');
        lazyImages.forEach(img => {
          if (img.complete) {
            img.classList.add('loaded');
          } else {
            img.addEventListener('load', () => {
              img.classList.add('loaded');
            }, { once: true });
          }
        });
      }

      // Init on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLazyImages);
      } else {
        initLazyImages();
      }
    </script>
  </body>
</html>