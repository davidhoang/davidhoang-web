---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map(note => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

const { note } = Astro.props;
const { Content } = await note.render();

// Stage info - using dots instead of emoji
const stageInfo = {
  seedling: { icon: '○', label: 'Seedling', description: 'Just planted—rough ideas and early thoughts' },
  budding: { icon: '◐', label: 'Budding', description: 'Growing and developing, but not yet complete' },
  evergreen: { icon: '●', label: 'Evergreen', description: 'Mature, stable, and regularly maintained' },
};

const stage = stageInfo[note.data.stage || 'seedling'];
const tags = note.data.tags || [];

// Format dates
const plantedDate = note.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const updatedDate = note.data.updatedDate
  ? note.data.updatedDate.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  : null;

const pageDescription = note.data.description || `A ${stage.label.toLowerCase()} note on ${note.data.title}`;
---

<MainLayout title={`${note.data.title} | Notes`} description={pageDescription} ogImage={note.data.ogImage}>
  <article class="note-article">
    <header class="note-header">
      <a href="/notes" class="back-link">&larr; Notes</a>
      <h1>{note.data.title}</h1>
      <div class="note-meta-row">
        <time datetime={note.data.pubDate.toISOString()}>{plantedDate}</time>
        <span class="meta-separator">·</span>
        <span class="note-stage" title={stage.description}>
          {stage.icon} {stage.label}
        </span>
        {tags.length > 0 && (
          <>
            <span class="meta-separator">·</span>
            <span class="note-tags-inline">
              {tags.map((tag, i) => (
                <span class="tag">{tag}{i < tags.length - 1 ? ', ' : ''}</span>
              ))}
            </span>
          </>
        )}
      </div>
      {note.data.description && (
        <p class="note-description">{note.data.description}</p>
      )}
    </header>

    <div class="note-content">
      <Content />
    </div>

    <footer class="note-footer">
      <div class="growth-notice">
        <span class="growth-icon">{stage.icon}</span>
        <p>
          This is a <strong>{stage.label.toLowerCase()}</strong> note—{stage.description.toLowerCase()}.
          Notes in my digital garden are meant to be tended over time.
        </p>
      </div>
      <a href="/notes" class="back-link">&larr; Back to all notes</a>
    </footer>
  </article>
</MainLayout>

<style>
  .note-article {
    max-width: 720px;
    margin: 0 auto;
    padding-top: 6rem;
  }

  .note-header {
    margin-bottom: 2rem;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--color-muted);
    text-decoration: none;
    transition: color 0.2s ease;
    display: inline-block;
    margin-bottom: 1.5rem;
  }

  .back-link:hover {
    color: var(--color-link);
  }

  .note-header h1 {
    font-size: 2.25rem;
    line-height: 1.2;
    margin: 0 0 0.75rem 0;
  }

  .note-meta-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-muted);
    margin-bottom: 1rem;
  }

  .note-meta-row time {
    color: var(--color-muted);
  }

  .meta-separator {
    color: var(--color-border);
  }

  .note-stage {
    cursor: help;
  }

  .note-tags-inline {
    color: var(--color-muted);
  }

  .note-tags-inline .tag {
    color: var(--color-muted);
  }

  .note-description {
    font-size: 1.125rem;
    color: var(--color-muted);
    line-height: 1.5;
    margin: 1rem 0 0 0;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .note-content {
    font-size: 1.0625rem;
    line-height: 1.75;
  }

  .note-content :global(h2) {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .note-content :global(h3) {
    font-size: 1.25rem;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .note-content :global(p) {
    margin-bottom: 1.25rem;
  }

  .note-content :global(ul),
  .note-content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }

  .note-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .note-content :global(blockquote) {
    border-left: 3px solid var(--color-link);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--color-muted);
    font-style: italic;
  }

  .note-content :global(code) {
    background: var(--color-sidebar-bg);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm, 4px);
    font-size: 0.9em;
  }

  .note-content :global(pre) {
    background: var(--color-sidebar-bg);
    padding: 1rem;
    border-radius: var(--radius-md, 8px);
    overflow-x: auto;
    margin-bottom: 1.25rem;
  }

  .note-content :global(pre code) {
    background: none;
    padding: 0;
  }

  .note-footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .growth-notice {
    display: flex;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--color-sidebar-bg);
    border-radius: var(--radius-md, 8px);
    margin-bottom: 1.5rem;
  }

  .growth-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
    color: var(--color-muted);
  }

  .growth-notice p {
    font-size: 0.875rem;
    color: var(--color-muted);
    margin: 0;
    line-height: 1.5;
  }

  @media (max-width: 640px) {
    .note-header h1 {
      font-size: 1.75rem;
    }

    .note-meta-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .meta-separator {
      display: none;
    }
  }
</style>
